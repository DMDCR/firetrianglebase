name: Cleanup Old Workflow Logs

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 */2 * *"

jobs:
  delete_logs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Delete old workflow logs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          logs=$(gh run list --limit 100)
          for run_id in $(echo "$logs" | awk '{print $1}'); do
            run_date=$(gh run view $run_id --json createdAt -q ".createdAt")
            run_timestamp=$(date -d "$run_date" +%s)
            current_timestamp=$(date +%s)
            age_in_hours=$((($current_timestamp - $run_timestamp) / 3600))

            if [ $age_in_hours -gt 48 ]; then
              gh run cancel $run_id
            fi
          done
